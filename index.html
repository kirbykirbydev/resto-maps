<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"> 
    <title>Simple Map</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdAb96ekVOdqHZv8O3rMIwxKf_WdRA65M&callback=initMap&libraries=places&v=weekly" defer ></script>
    
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }

  /* Optional: Makes the sample page fill the window. */
  html,
  body {
    height: 100%;
    margin: 0;
    padding: 0;
  }

  #floating-panel {
    position: absolute;
    top: 100px;
    left: 10px;
    z-index: 5;
    background-color: #fff;
    padding: 5px;
    border: 1px solid #999;
    text-align: center;
    font-family: "Roboto", "sans-serif";
    line-height: 30px;
    padding-left: 10px;
  }

  #right-panel {
    font-family: "Roboto", "sans-serif";
    line-height: 30px;
    padding-left: 10px;
  }

  #right-panel select,
  #right-panel input {
    font-size: 15px;
  }

  #right-panel select {
    width: 100%;
  }

  #right-panel i {
    font-size: 12px;
  }

  #right-panel {
    height: 100%;
    float: right;
    width: 390px;
    overflow: auto;
  }

  

  #floating-panel {
    background: #fff;
    padding: 5px;
    font-size: 14px;
    font-family: Arial;
    border: 1px solid #ccc;
    box-shadow: 0 2px 2px rgba(33, 33, 33, 0.4);
    /* display: none; */
  }

  @media print {
    #map {
      height: 500px;
      margin: 0;
    }

    #right-panel {
      float: none;
      width: auto;
    }
  }
</style>

    <script>
      (function(exports) {
        "use strict";

        // initialize marker conteiner
        exports.markers = [];
        exports.radius = 3000 ; // 2km
        // initial location
        function initMap() {
          
          exports.mapCenter = { // default CEBU CITY
            lat: 10.3096607,
            lng: 123.8960727
          };

          exports.restaurantTypes = [ 'restaurant', 'cafe', 'meal_delivery', 'meal_delivery'] ;

          // for restaurant type panel
          exports.directionsRenderer = new google.maps.DirectionsRenderer();

          // this is to display info on map item
          exports.infowindow = new google.maps.InfoWindow();
          exports.map = new google.maps.Map(document.getElementById("map"), {
            zoom: 15
          });

          exports.service = new google.maps.places.PlacesService(exports.map);
          

            /* setup autocomplete box*/
            var input = document.getElementById("autoinput");
            exports.autocomplete = new google.maps.places.Autocomplete(input);

            // Bind the map's bounds (viewport) property to the autocomplete object,
            // so that the autocomplete requests use the current map bounds for the
            // bounds option in the request.
            exports.autocomplete.bindTo('bounds', exports.map);

            // Set the data fields to return when the user selects a place.
            exports.autocomplete.setFields(
            ['address_components', 'geometry', 'icon', 'name']);

            autocomplete.addListener('place_changed', function() {
              var place = autocomplete.getPlace();
                console.log(place);

                exports.mapCenter = place.geometry.location;
                console.log(place.geometry.location);

                init_after_location_resolved( { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() } ) ;
            } );

            /* end setup autocomplete box*/



          function init_after_location_resolved( loc ){
            // just in case
            exports.mapCenter = loc;

            exports.pointA = new google.maps.LatLng(loc.lat, loc.lng);

            exports.defaultBounds = new google.maps.LatLng(loc.lat, loc.lng );

            exports.map.setCenter(loc);


            if( exports.cityCircle ){
              exports.cityCircle.setMap(null);
            }

            exports.cityCircle = new google.maps.Circle({
              strokeColor: "#00EE00",
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: "#00EE00",
              fillOpacity: 0.10,
              map: map,
              center: exports.pointA,
              radius: exports.radius
            });

            // execute initial search
            initial_load_search( loc );



          }


          function initial_load_search( loc ){

            console.log('initial search');
            var request = {
              location: loc,
              radius: exports.radius,
              type: exports.restaurantTypes
            };

            
            exports.markers.forEach( function(item, index){ item.setMap(null) } );
            

            exports.service.nearbySearch(request, fetch_results );


          }




          // get current location if available
          if ( navigator.geolocation) {
            console.log('location available');
            
            navigator.geolocation.getCurrentPosition(function(position) {
              console.log('location allowed');
              exports.mapCenter = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };

              init_after_location_resolved( loc );

            }, function(err) {
              console.log(err);
              console.log('location not permitted');
              init_after_location_resolved( exports.mapCenter );
            },
            {timeout:3000} );
           } 
          else{
            console.log('position not available ' );
            init_after_location_resolved( exports.mapCenter );
            
            console.log( exports.mapCenter );
          }
          
          init_after_location_resolved( exports.mapCenter );
          
          


          





          // configure panel
          exports.directionsRenderer.setMap(exports.map);
          exports.directionsRenderer.setPanel(document.getElementById("right-panel"));

          exports.directionsService = new google.maps.DirectionsService;
          exports.directionsDisplay = new google.maps.DirectionsRenderer({
            map: exports.map
          });
          // end panel config

          

          function fetch_results( results, status  ){
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              for (var i = 0; i < results.length; i++) {

                createMarker(results[i]);
              }
              //exports.map.setCenter(results[0].geometry.location);
            }
          }

          
          

          var onChangeHandler = function( e ) {

            let value = document.getElementById("restaurant-options").value;
            if( ! value ){
              var inType = exports.restaurantTypes ;
            }
            else{
              var inType =  [ value ] ;
            }

            // get cuisine options

            var request = {
              location: exports.defaultBounds,
              radius: exports.radius,
              type: inType
            };

            let cuisineVal = document.getElementById("restaurant-cuisine").value;
            if( cuisineVal ){
              request.keyword = cuisineVal;
            }
            
            exports.markers.forEach( function(item, index){ item.setMap(null) } );
            // clear directions
            // reset display
            exports.directionsDisplay.setMap(null);
              exports.directionsDisplay = new google.maps.DirectionsRenderer({
              map: exports.map
            });

            // clear markers first
            exports.markers = [];
            exports.service.nearbySearch(request, fetch_results );
            
          };

          document.getElementById("restaurant-options").addEventListener('change', onChangeHandler );
          document.getElementById("restaurant-cuisine").addEventListener('change', onChangeHandler );
          


          

          exports.getPlaceDetail = function( id, format_result ){
            console.log("using place id: "+ id );
            var request = {
              placeId: id,
              fields: ['name', 'rating', 'formatted_phone_number', 'geometry', 'user_ratings_total']
            };
            // var request = {
            //   placeId: 'ChIJN1t_tDeuEmsRUsoyG83frY4',
            //   fields: ['name', 'rating', 'formatted_phone_number', 'geometry']
            // };


            exports.service.getDetails(request, function(result, status){
              format_result(result);

            });


          }


        }

        // var pointB = new google.maps.LatLng(10.309196, 123.902166);

        //calculateAndDisplayRoute(directionsService, directionsDisplay, pointA, pointB);

        function calculateAndDisplayRoute(directionsService, directionsDisplay, pointA, pointB) {
          directionsService.route({
            origin: pointA,
            destination: pointB,
            travelMode: google.maps.TravelMode.DRIVING
          }, function(response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
              directionsDisplay.setDirections(response);
            } else {
              window.alert('Directions request failed due to ' + status);
            }
          });
        } 


        function getDirectionsFrom(location_lat, location_lng){
          var pointB = {
              lat: location_lat,
              lng: location_lng
            };
          calculateAndDisplayRoute(exports.directionsService, exports.directionsDisplay, exports.pointA, pointB);

        }


        function createMarker(place) {
          var marker = new google.maps.Marker({
            map: exports.map,
            position: place.geometry.location
          });

          exports.markers.push(marker);





          google.maps.event.addListener(marker, "click", function() {



            /* format contents of info box */
            var directionsLink = document.createElement("a");
            directionsLink.addEventListener("click", function( e ){  
              e.preventDefault();
              getDirectionsFrom(place.geometry.location.lat(), place.geometry.location.lng())
              
            } );
            
            directionsLink.innerHTML = "Get Directions";
            
            directionsLink.setAttribute( 'href', '#'  ) ;

            var placeName = document.createElement("span");
            placeName.innerHTML = place.name;

            var info_content = document.createElement("div");
            info_content.appendChild(placeName);
            info_content.appendChild(document.createElement("br"));
            info_content.appendChild(directionsLink);
            /* end info formatting */



            /* place detials */

            exports.getPlaceDetail(place.place_id, function(result){
              console.log('formatting results');
              console.log( result  );

              if( result.user_ratings_total ){
                // review count
                let placeReviewCountElem = document.createElement("div");
                placeReviewCountElem.innerHTML = result.user_ratings_total + " have reviewed this place";
                info_content.appendChild(placeReviewCountElem);
              }
              




            } );


            /* end place details */




            exports.infowindow.setContent(info_content);
            exports.infowindow.open(exports.map, this);





          });
        }
        

        exports.createMarker = createMarker;

        exports.initMap = initMap;
      })((this.window = this.window || {}));
    </script>
  </head>
  <body  >


    <div id="floating-panel">


      <div id="pac-container">
        <span><strong>Select Area</strong></span><br>
        <input id="autoinput" type="text" value="Cebu City"
            placeholder="Enter a location">
      </div>


      <div>
        <strong>Restaurant Types:</strong><br>
        <select id="restaurant-options">
          <option value="restaurant">-- Filter --</option>
          <option value="cafe">Cafe</option>
          <option value="meal_delivery" >Meal Delivery</option>
          <option value="meal_takeaway" >Meal Takeaway</option>
        </select>
      </div>
      
      <div>
        <strong>Cuisine Types:</strong><br>
        <select id="restaurant-cuisine">
          <option value="">-- Filter --</option>
          <option value="japanese">Japanese</option>
          <option value="italian">Italian</option>
          <option value="chinese" >Chinese</option>
          <option value="filipino" >Filipino</option>
        </select>
      </div>




      
    </div>

    


    <div id="map"></div>
  </body>
</html>